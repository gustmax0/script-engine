<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Script Engine</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0d;
    --bg-chat: #0d0d0d;
    --surface: #1a1a1a;
    --surface-2: #222;
    --surface-3: #2a2a2a;
    --border: #333;
    --border-light: #444;
    --text: #ececec;
    --text-2: #b0b0b0;
    --text-3: #777;
    --accent: #4a9eff;
    --accent-dim: rgba(74, 158, 255, 0.15);
    --green: #10b981;
    --orange: #f59e0b;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* â”€â”€ Chat area â”€â”€ */
  .chat-area {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    scrollbar-width: thin;
    scrollbar-color: #333 transparent;
  }

  .chat-area::-webkit-scrollbar { width: 6px; }
  .chat-area::-webkit-scrollbar-track { background: transparent; }
  .chat-area::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

  /* Empty state */
  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 40px;
  }

  .empty-state.hidden { display: none; }

  .empty-state h1 {
    font-size: 28px;
    font-weight: 600;
    color: var(--text);
  }

  .empty-state p {
    font-size: 15px;
    color: var(--text-3);
  }

  /* Messages */
  .messages {
    max-width: 780px;
    width: 100%;
    margin: 0 auto;
    padding: 24px 20px;
    display: none;
    flex-direction: column;
    gap: 32px;
  }

  .messages.visible {
    display: flex;
  }

  .message {
    animation: msgIn 0.3s ease-out;
  }

  @keyframes msgIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .message .msg-label {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .message.user .msg-label { color: var(--text-2); }
  .message.assistant .msg-label { color: var(--accent); }

  .msg-label .avatar {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
  }

  .message.user .avatar {
    background: var(--surface-3);
    color: var(--text-2);
  }

  .message.assistant .avatar {
    background: var(--accent-dim);
    color: var(--accent);
  }

  .msg-body {
    padding-left: 32px;
    font-size: 15px;
    line-height: 1.75;
    color: var(--text);
  }

  .msg-body.user-prompt {
    color: var(--text);
    white-space: pre-wrap;
  }

  .msg-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding-left: 32px;
    margin-top: 8px;
  }

  .msg-tag {
    font-size: 11px;
    font-family: 'JetBrains Mono', monospace;
    padding: 3px 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-3);
  }

  /* Script output */
  .script-content {
    font-size: 15px;
    line-height: 1.8;
    white-space: pre-wrap;
    color: var(--text);
  }

  /* Streaming cursor */
  .streaming .script-content::after {
    content: 'â–‹';
    animation: blink 0.8s infinite;
    color: var(--accent);
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  /* Actions bar under script */
  .script-actions {
    display: flex;
    gap: 4px;
    padding-left: 32px;
    margin-top: 12px;
  }

  .script-action-btn {
    background: none;
    border: 1px solid transparent;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 13px;
    color: var(--text-3);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.15s;
  }

  .script-action-btn:hover {
    background: var(--surface);
    color: var(--text-2);
    border-color: var(--border);
  }

  .script-action-btn.copied {
    color: var(--green);
  }

  /* â”€â”€ Input area â”€â”€ */
  .input-area {
    padding: 16px 20px 24px;
    display: flex;
    justify-content: center;
  }

  .input-container {
    max-width: 780px;
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 0;
    transition: border-color 0.2s;
    position: relative;
  }

  .input-container:focus-within {
    border-color: var(--border-light);
  }

  .input-container textarea {
    width: 100%;
    background: transparent;
    border: none;
    padding: 16px 20px 8px;
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    color: var(--text);
    outline: none;
    resize: none;
    min-height: 52px;
    max-height: 200px;
    line-height: 1.5;
  }

  .input-container textarea::placeholder {
    color: var(--text-3);
  }

  .input-bottom {
    display: flex;
    align-items: center;
    padding: 8px 12px 12px;
    gap: 6px;
  }

  /* Pills */
  .pill {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text-2);
    transition: all 0.15s;
    white-space: nowrap;
    position: relative;
  }

  .pill:hover {
    background: var(--surface-2);
    border-color: var(--border-light);
  }

  .pill.active {
    background: var(--accent-dim);
    border-color: rgba(74, 158, 255, 0.3);
    color: var(--accent);
  }

  .pill .pill-arrow {
    font-size: 10px;
    color: var(--text-3);
  }

  .pill .pill-x {
    font-size: 14px;
    margin-left: 2px;
  }

  .pill-text {
    display: inline-block;
  }

  /* Send button */
  .send-btn {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: none;
    background: var(--text);
    color: var(--bg);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: auto;
    transition: all 0.15s;
    font-size: 16px;
  }

  .send-btn:hover { opacity: 0.85; }

  .send-btn:disabled {
    background: var(--surface-3);
    color: var(--text-3);
    cursor: not-allowed;
  }

  /* â”€â”€ Dropdowns â”€â”€ */
  .dropdown {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 6px;
    min-width: 240px;
    max-height: 380px;
    overflow-y: auto;
    box-shadow: 0 8px 40px rgba(0,0,0,0.5);
    z-index: 100;
    display: none;
    scrollbar-width: thin;
    scrollbar-color: #333 transparent;
  }

  .dropdown.visible { display: block; animation: dropIn 0.15s ease-out; }

  @keyframes dropIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .dropdown-group {
    padding: 8px 10px 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-3);
  }

  .dropdown-item {
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: background 0.1s;
  }

  .dropdown-item:hover { background: var(--surface-2); }

  .dropdown-item.selected { background: var(--accent-dim); }

  .dropdown-item .di-label {
    font-size: 14px;
    color: var(--text);
  }

  .dropdown-item .di-meta {
    font-size: 12px;
    color: var(--text-3);
  }

  .dropdown-item .di-check {
    color: var(--accent);
    font-size: 14px;
    opacity: 0;
  }

  .dropdown-item.selected .di-check { opacity: 1; }

  .dropdown-divider {
    height: 1px;
    background: var(--border);
    margin: 4px 8px;
  }

  /* â”€â”€ Frameworks dropdown â”€â”€ */
  .fw-dropdown {
    min-width: 320px;
  }

  .fw-dropdown .fw-header {
    display: flex;
    justify-content: space-between;
    padding: 10px 12px 6px;
  }

  .fw-dropdown .fw-toggle {
    font-size: 12px;
    color: var(--accent);
    cursor: pointer;
    background: none;
    border: none;
    font-family: 'Inter', sans-serif;
  }

  .fw-dropdown .fw-toggle:hover { text-decoration: underline; }

  .fw-item {
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    transition: background 0.1s;
  }

  .fw-item:hover { background: var(--surface-2); }

  .fw-check {
    width: 18px;
    height: 18px;
    border: 1.5px solid var(--border-light);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    flex-shrink: 0;
    margin-top: 1px;
    transition: all 0.15s;
  }

  .fw-item.selected .fw-check {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }

  .fw-info .fw-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
  }

  .fw-info .fw-desc {
    font-size: 12px;
    color: var(--text-3);
    margin-top: 1px;
  }

  /* â”€â”€ Context modal â”€â”€ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.visible { display: flex; }

  /* Prevent body scroll when modal is open on mobile */
  body.modal-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
  }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 560px;
    max-width: 90vw;
    max-height: 80vh;
    overflow-y: auto;
    animation: dropIn 0.2s ease-out;
  }

  .modal-header {
    padding: 20px 24px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-header h3 {
    font-size: 16px;
    font-weight: 600;
  }

  .modal-close {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--text-3);
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover { background: var(--surface-2); color: var(--text); }

  .modal-body { padding: 16px 24px 24px; }

  .ctx-section {
    margin-bottom: 16px;
  }

  .ctx-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-3);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .ctx-label .icon {
    font-size: 14px;
  }

  .ctx-input-row {
    display: flex;
    gap: 6px;
  }

  .ctx-input-row input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    color: var(--text);
    outline: none;
  }

  .ctx-input-row input:focus { border-color: var(--border-light); }
  .ctx-input-row input::placeholder { color: var(--text-3); }

  .ctx-input-row button {
    padding: 10px 16px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text-2);
    cursor: pointer;
    font-size: 13px;
    white-space: nowrap;
    transition: all 0.15s;
  }

  .ctx-input-row button:hover {
    background: var(--surface-3);
    color: var(--text);
  }

  .ctx-file-area {
    border: 1px dashed var(--border);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s;
    color: var(--text-3);
    font-size: 14px;
  }

  .ctx-file-area:hover { border-color: var(--border-light); }
  .ctx-file-area input { display: none; }

  .ctx-textarea {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 14px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    color: var(--text);
    outline: none;
    resize: vertical;
    min-height: 80px;
  }

  .ctx-textarea:focus { border-color: var(--border-light); }
  .ctx-textarea::placeholder { color: var(--text-3); }

  .ctx-sources {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 12px;
  }

  .ctx-tag {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 12px;
    color: var(--text-2);
  }

  .ctx-tag .remove {
    cursor: pointer;
    color: var(--text-3);
    font-size: 14px;
  }

  .ctx-tag .remove:hover { color: #f87171; }

  .ctx-done-btn {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: none;
    background: var(--accent);
    color: #fff;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    transition: opacity 0.15s;
  }

  .ctx-done-btn:hover { opacity: 0.9; }

  /* â”€â”€ Loading message â”€â”€ */
  .thinking {
    display: flex;
    align-items: center;
    gap: 8px;
    padding-left: 32px;
    color: var(--text-3);
    font-size: 14px;
  }

  .thinking-dots span {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-3);
    animation: dotPulse 1.4s infinite;
  }

  .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
  .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes dotPulse {
    0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
    40% { opacity: 1; transform: scale(1); }
  }

  /* â”€â”€ Mobile Responsive Styles â”€â”€ */
  @media (max-width: 768px) {
    body {
      height: 100vh;
      height: 100dvh; /* Dynamic viewport height for mobile */
      overflow: hidden;
    }

    /* Empty state */
    .empty-state {
      padding: 24px 20px;
    }

    .empty-state h1 {
      font-size: 24px;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* Messages */
    .messages {
      padding: 16px 12px;
      gap: 24px;
    }

    .message .msg-label {
      font-size: 12px;
      margin-bottom: 6px;
    }

    .msg-label .avatar {
      width: 20px;
      height: 20px;
      font-size: 11px;
    }

    .msg-body {
      padding-left: 28px;
      font-size: 14px;
      line-height: 1.6;
    }

    .msg-tags {
      padding-left: 28px;
      margin-top: 6px;
      gap: 4px;
    }

    .msg-tag {
      font-size: 10px;
      padding: 2px 6px;
    }

    .script-content {
      font-size: 14px;
      line-height: 1.7;
    }

    .script-actions {
      padding-left: 28px;
      margin-top: 10px;
      flex-wrap: wrap;
      gap: 6px;
    }

    .script-action-btn {
      padding: 8px 12px;
      font-size: 12px;
      min-height: 44px; /* Touch target */
    }

    /* Input area */
    .input-area {
      padding: 12px 12px 16px;
      padding-bottom: max(16px, env(safe-area-inset-bottom));
    }

    .input-container {
      border-radius: 16px;
    }

    .input-container textarea {
      padding: 12px 16px 6px;
      font-size: 16px; /* Prevents zoom on iOS */
      min-height: 48px;
      line-height: 1.4;
    }

    .input-bottom {
      padding: 6px 10px 10px;
      gap: 4px;
      flex-wrap: wrap;
    }

    /* Pills - mobile optimized */
    .pill {
      padding: 8px 10px;
      font-size: 12px;
      min-height: 36px;
      touch-action: manipulation;
    }

    .pill .pill-x {
      font-size: 16px;
      padding: 2px;
      margin-left: 4px;
    }

    /* Send button */
    .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      font-size: 18px;
      flex-shrink: 0;
    }

    /* Dropdowns - mobile */
    .dropdown {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      top: auto;
      border-radius: 20px 20px 0 0;
      max-height: 70vh;
      min-width: auto;
      width: 100%;
      box-shadow: 0 -8px 40px rgba(0,0,0,0.5);
      padding: 12px 8px;
    }

    .fw-dropdown {
      min-width: auto;
    }

    .dropdown-item {
      padding: 14px 16px;
      min-height: 48px; /* Touch target */
      touch-action: manipulation;
    }

    .dropdown-item .di-label {
      font-size: 15px;
    }

    .dropdown-item .di-meta {
      font-size: 13px;
    }

    .fw-item {
      padding: 12px 16px;
      min-height: 56px;
      touch-action: manipulation;
    }

    .fw-check {
      width: 20px;
      height: 20px;
      font-size: 12px;
    }

    .fw-info .fw-name {
      font-size: 14px;
    }

    .fw-info .fw-desc {
      font-size: 12px;
    }

    .fw-dropdown .fw-header {
      padding: 12px 16px 8px;
    }

    .fw-dropdown .fw-toggle {
      font-size: 13px;
      padding: 8px;
      min-height: 44px;
      touch-action: manipulation;
    }

    /* Modal - full screen on mobile */
    .modal-overlay {
      align-items: flex-end;
      padding: 0;
      backdrop-filter: blur(8px);
    }

    /* Prevent scroll bounce on iOS */
    body.modal-open {
      position: fixed;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .modal {
      width: 100%;
      max-width: 100%;
      max-height: 90vh;
      border-radius: 20px 20px 0 0;
      margin: 0;
    }

    .modal-header {
      padding: 16px 20px 0;
      position: sticky;
      top: 0;
      background: var(--surface);
      z-index: 10;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h3 {
      font-size: 18px;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      font-size: 20px;
      touch-action: manipulation;
    }

    .modal-body {
      padding: 16px 20px max(24px, env(safe-area-inset-bottom));
    }

    .ctx-section {
      margin-bottom: 20px;
    }

    .ctx-label {
      font-size: 13px;
      margin-bottom: 8px;
    }

    .ctx-input-row {
      flex-direction: column;
      gap: 8px;
    }

    .ctx-input-row input {
      padding: 12px 16px;
      font-size: 16px; /* Prevents zoom on iOS */
      min-height: 48px;
    }

    .ctx-input-row button {
      padding: 12px 16px;
      font-size: 14px;
      min-height: 48px;
      width: 100%;
      touch-action: manipulation;
    }

    .ctx-file-area {
      padding: 24px 16px;
      font-size: 14px;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
    }

    .ctx-textarea {
      padding: 12px 16px;
      font-size: 16px; /* Prevents zoom on iOS */
      min-height: 100px;
    }

    .ctx-tag {
      padding: 6px 12px;
      font-size: 12px;
      min-height: 32px;
    }

    .ctx-tag .remove {
      font-size: 16px;
      padding: 2px;
      min-width: 24px;
      min-height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
    }

    .ctx-done-btn {
      padding: 16px;
      font-size: 15px;
      min-height: 52px;
      touch-action: manipulation;
      margin-top: 12px;
    }

    /* Thinking indicator */
    .thinking {
      padding-left: 28px;
      font-size: 13px;
    }

    /* Prevent text selection on buttons for better touch */
    button, .pill, .dropdown-item, .fw-item {
      -webkit-tap-highlight-color: rgba(74, 158, 255, 0.2);
      user-select: none;
    }

    /* Better scrolling on mobile */
    .chat-area {
      -webkit-overflow-scrolling: touch;
    }

    .modal {
      -webkit-overflow-scrolling: touch;
    }

    .dropdown {
      -webkit-overflow-scrolling: touch;
    }
  }

  /* Very small screens */
  @media (max-width: 360px) {
    .empty-state h1 {
      font-size: 20px;
    }

    .input-bottom {
      gap: 3px;
    }

    .pill {
      padding: 6px 8px;
      font-size: 11px;
    }

    .pill-text {
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  }

  /* Landscape mobile */
  @media (max-width: 768px) and (orientation: landscape) {
    .modal {
      max-height: 85vh;
    }

    .dropdown {
      max-height: 60vh;
    }
  }
</style>
</head>
<body>

<!-- Chat Area -->
<div class="chat-area" id="chatArea">
  <div class="empty-state" id="emptyState">
    <h1>Generate Script</h1>
    <p>Enter a prompt/title below</p>
  </div>
  <div class="messages" id="messages"></div>
</div>

<!-- Context Modal -->
<div class="modal-overlay" id="ctxModal" onclick="if(event.target === this) closeContextModal()">
  <div class="modal">
    <div class="modal-header">
      <h3>Add Context</h3>
      <button class="modal-close" onclick="closeContextModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="ctx-section">
        <div class="ctx-label"><span class="icon" style="color:#f87171">â–¶</span> YouTube Video</div>
        <div class="ctx-input-row">
          <input type="url" id="ctxYoutube" placeholder="https://youtube.com/watch?v=...">
          <button onclick="addYouTubeCtx()">Add</button>
        </div>
      </div>
      <div class="ctx-section">
        <div class="ctx-label"><span class="icon" style="color:#60a5fa">âŠ•</span> Article / Webpage</div>
        <div class="ctx-input-row">
          <input type="url" id="ctxArticle" placeholder="https://example.com/article">
          <button onclick="addArticleCtx()">Add</button>
        </div>
      </div>
      <div class="ctx-section">
        <div class="ctx-label"><span class="icon" style="color:#a78bfa">ðŸ“„</span> Upload File</div>
        <div class="ctx-file-area" onclick="document.getElementById('ctxFileInput').click()">
          <span id="ctxFileLabel">Click to upload PDF, TXT, MD, CSV</span>
          <input type="file" id="ctxFileInput" accept=".pdf,.txt,.md,.docx,.csv,.json" onchange="addFileCtx(this)">
        </div>
      </div>
      <div class="ctx-section">
        <div class="ctx-label"><span class="icon" style="color:#10b981">âœŽ</span> Manual Text</div>
        <textarea class="ctx-textarea" id="ctxManual" placeholder="Paste competitor research, product docs, talking points..."></textarea>
      </div>
      <div class="ctx-sources" id="ctxSources"></div>
      <button class="ctx-done-btn" onclick="closeContextModal()">Done</button>
    </div>
  </div>
</div>

<!-- Input Area -->
<div class="input-area">
  <div class="input-container" id="inputContainer">
    <textarea id="promptInput" placeholder="Enter a prompt to generate a script..." rows="1" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
    <div class="input-bottom">
      <!-- Context -->
      <div class="pill" onclick="openContextModal()" id="ctxPill">
        <span class="pill-text">+ Context</span>
      </div>

      <!-- Frameworks -->
      <div style="position:relative" id="fwPillWrap">
        <div class="pill active" onclick="toggleDropdown('fwDropdown')" id="fwPill">
          <span id="fwPillText" class="pill-text">Selected (10)</span>
          <span class="pill-x" onclick="event.stopPropagation(); clearFrameworks()">âœ•</span>
        </div>
        <div class="dropdown fw-dropdown" id="fwDropdown"></div>
      </div>

      <!-- Word Count -->
      <div style="position:relative" id="wcPillWrap">
        <div class="pill" onclick="toggleDropdown('wcDropdown')" id="wcPill">
          <span id="wcPillText" class="pill-text">1000 words (~6.7...</span>
          <span class="pill-arrow">â–¾</span>
        </div>
        <div class="dropdown" id="wcDropdown"></div>
      </div>

      <!-- Tone -->
      <div style="position:relative" id="tonePillWrap">
        <div class="pill" onclick="toggleDropdown('toneDropdown')" id="tonePill">
          <span id="tonePillText" class="pill-text">Conversational</span>
          <span class="pill-arrow">â–¾</span>
        </div>
        <div class="dropdown" id="toneDropdown"></div>
      </div>

      <!-- Send -->
      <button class="send-btn" id="sendBtn" onclick="generate()" title="Generate">â†‘</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” set your webhook URL here
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WEBHOOK_URL = 'https://xtok.app.n8n.cloud/webhook/generate-script';

// â”€â”€ State â”€â”€
let selectedWordCount = 1000;
let selectedTone = 'Conversational & Energetic';
const selectedFrameworks = new Set([
  'hook','intro','value_loop','ordering','pacing','emotion','payoff','psychology','outro','algorithm'
]);
const contextSources = [];
let isGenerating = false;

// â”€â”€ Word count options â”€â”€
const WC_OPTIONS = [
  { group: 'Shorts', items: [
    { v: 100, l: '100 words', t: '~1 min' },
    { v: 150, l: '150 words', t: '~1.5 min' },
    { v: 200, l: '200 words', t: '~1.8 min' },
    { v: 250, l: '250 words', t: '~2 min' },
    { v: 300, l: '300 words', t: '~2.5 min' },
  ]},
  { group: 'Long Form', items: [
    { v: 500, l: '500 words', t: '~3.3 min' },
    { v: 750, l: '750 words', t: '~5 min' },
    { v: 1000, l: '1,000 words', t: '~6.7 min' },
    { v: 1250, l: '1,250 words', t: '~8.3 min' },
    { v: 1500, l: '1,500 words', t: '~10 min' },
    { v: 2000, l: '2,000 words', t: '~13 min' },
    { v: 2500, l: '2,500 words', t: '~16 min' },
  ]}
];

const TONES = [
  { v: 'Conversational & Energetic', l: 'Conversational' },
  { v: 'Professional & Authoritative', l: 'Professional' },
  { v: 'Educational & Calm', l: 'Educational' },
  { v: 'Storytelling & Emotional', l: 'Storytelling' },
  { v: 'Hype & Motivational', l: 'Motivational' },
];

const FW_DATA = [
  { key: 'hook',       name: 'Viral Hook Database',   desc: 'Proven opening hooks' },
  { key: 'intro',      name: 'Intro Frameworks',      desc: 'Strong openings & tone' },
  { key: 'value_loop', name: 'Value Loop Structure',   desc: 'Regular value delivery' },
  { key: 'ordering',   name: 'Strategic Ordering',     desc: 'Narrative flow' },
  { key: 'pacing',     name: 'Tension and Pacing',     desc: 'Energy management' },
  { key: 'emotion',    name: 'Emotional Waves',        desc: 'Emotional highs & lows' },
  { key: 'payoff',     name: 'Payoff Structuring',     desc: 'Viewer rewards' },
  { key: 'psychology', name: 'Advanced Psychology',     desc: 'Cognitive triggers' },
  { key: 'outro',      name: 'Outro Strategy',         desc: 'Impactful endings' },
  { key: 'algorithm',  name: 'Algorithm Optimization',  desc: 'YouTube algorithm' },
];

// â”€â”€ Render dropdowns â”€â”€
function renderWcDropdown() {
  const dd = document.getElementById('wcDropdown');
  dd.innerHTML = WC_OPTIONS.map(g => `
    <div class="dropdown-group">${g.group}</div>
    ${g.items.map(i => `
      <div class="dropdown-item ${i.v === selectedWordCount ? 'selected' : ''}" onclick="selectWc(${i.v}, '${i.l}', '${i.t}')">
        <div>
          <div class="di-label">${i.l}</div>
          <div class="di-meta">${i.t}</div>
        </div>
        <span class="di-check">âœ“</span>
      </div>
    `).join('')}
  `).join('<div class="dropdown-divider"></div>');
}

function selectWc(v, l, t) {
  selectedWordCount = v;
  const pillText = document.getElementById('wcPillText');
  // Truncate on mobile
  if (window.innerWidth <= 768) {
    pillText.textContent = `${l.split(' ')[0]} (${t})`;
  } else {
    pillText.textContent = `${l} (${t})`;
  }
  renderWcDropdown();
  closeAllDropdowns();
}

function renderToneDropdown() {
  const dd = document.getElementById('toneDropdown');
  dd.innerHTML = TONES.map(t => `
    <div class="dropdown-item ${t.v === selectedTone ? 'selected' : ''}" onclick="selectTone('${t.v}', '${t.l}')">
      <span class="di-label">${t.l}</span>
      <span class="di-check">âœ“</span>
    </div>
  `).join('');
}

function selectTone(v, l) {
  selectedTone = v;
  document.getElementById('tonePillText').textContent = l;
  renderToneDropdown();
  closeAllDropdowns();
}

function renderFwDropdown() {
  const dd = document.getElementById('fwDropdown');
  const allSelected = selectedFrameworks.size === FW_DATA.length;
  dd.innerHTML = `
    <div class="fw-header">
      <span style="font-size:12px;color:var(--text-3)">Frameworks</span>
      <button class="fw-toggle" onclick="event.stopPropagation(); ${allSelected ? 'clearFrameworks()' : 'selectAllFrameworks()'}">${allSelected ? 'Deselect all' : 'Select all'}</button>
    </div>
    ${FW_DATA.map(f => `
      <div class="fw-item ${selectedFrameworks.has(f.key) ? 'selected' : ''}" onclick="event.stopPropagation(); toggleFw('${f.key}')">
        <div class="fw-check">${selectedFrameworks.has(f.key) ? 'âœ“' : ''}</div>
        <div class="fw-info">
          <div class="fw-name">${f.name}</div>
          <div class="fw-desc">${f.desc}</div>
        </div>
      </div>
    `).join('')}
  `;
  updateFwPill();
}

function toggleFw(key) {
  if (selectedFrameworks.has(key)) selectedFrameworks.delete(key);
  else selectedFrameworks.add(key);
  renderFwDropdown();
}

function selectAllFrameworks() {
  FW_DATA.forEach(f => selectedFrameworks.add(f.key));
  renderFwDropdown();
}

function clearFrameworks() {
  selectedFrameworks.clear();
  renderFwDropdown();
  closeAllDropdowns();
}

function updateFwPill() {
  const pill = document.getElementById('fwPill');
  const text = document.getElementById('fwPillText');
  const n = selectedFrameworks.size;
  // Shorter text on mobile
  if (window.innerWidth <= 768) {
    text.textContent = n > 0 ? `${n}` : 'FW';
  } else {
    text.textContent = n > 0 ? `Selected (${n})` : 'Frameworks';
  }
  pill.classList.toggle('active', n > 0);
}

// â”€â”€ Dropdown toggle â”€â”€
function toggleDropdown(id) {
  const dd = document.getElementById(id);
  const wasVisible = dd.classList.contains('visible');
  closeAllDropdowns();
  if (!wasVisible) dd.classList.add('visible');
}

function closeAllDropdowns() {
  document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('visible'));
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('.pill') && !e.target.closest('.dropdown')) {
    closeAllDropdowns();
  }
});

// Close dropdowns on mobile when scrolling
let scrollTimeout;
document.addEventListener('scroll', () => {
  if (window.innerWidth <= 768) {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      closeAllDropdowns();
    }, 150);
  }
}, true);

// Handle window resize to update pill text
window.addEventListener('resize', () => {
  updateFwPill();
  const wcLabel = WC_OPTIONS.flatMap(g => g.items).find(i => i.v === selectedWordCount);
  if (wcLabel) {
    const pillText = document.getElementById('wcPillText');
    if (window.innerWidth <= 768) {
      pillText.textContent = `${wcLabel.l.split(' ')[0]} (${wcLabel.t})`;
    } else {
      pillText.textContent = `${wcLabel.l} (${wcLabel.t})`;
    }
  }
});

// â”€â”€ Context Modal â”€â”€

function closeContextModal() {
  document.getElementById('ctxModal').classList.remove('visible');
  updateCtxPill();
  document.body.classList.remove('modal-open');
}

function openContextModal() {
  document.getElementById('ctxModal').classList.add('visible');
  renderCtxSources();
  if (window.innerWidth <= 768) {
    document.body.classList.add('modal-open');
  }
}

function addYouTubeCtx() {
  const input = document.getElementById('ctxYoutube');
  const url = input.value.trim();
  if (!url) return;
  contextSources.push({ type: 'youtube', label: 'YT: ' + url.substring(0, 45), content: 'YouTube reference: ' + url });
  input.value = '';
  renderCtxSources();
}

function addArticleCtx() {
  const input = document.getElementById('ctxArticle');
  const url = input.value.trim();
  if (!url) return;
  contextSources.push({ type: 'article', label: 'Web: ' + url.substring(0, 45), content: 'Article reference: ' + url });
  input.value = '';
  renderCtxSources();
}

async function addFileCtx(input) {
  const file = input.files[0];
  if (!file) return;
  try {
    const content = await file.text();
    contextSources.push({ type: 'file', label: file.name, content });
  } catch {
    contextSources.push({ type: 'file', label: file.name, content: '[Could not read file]' });
  }
  input.value = '';
  document.getElementById('ctxFileLabel').textContent = 'Click to upload PDF, TXT, MD, CSV';
  renderCtxSources();
}

function removeCtx(idx) {
  contextSources.splice(idx, 1);
  renderCtxSources();
}

function renderCtxSources() {
  const el = document.getElementById('ctxSources');
  el.innerHTML = contextSources.map((s, i) => `
    <span class="ctx-tag">${s.label} <span class="remove" onclick="removeCtx(${i})">âœ•</span></span>
  `).join('');
}

function updateCtxPill() {
  const manual = document.getElementById('ctxManual').value.trim();
  const total = contextSources.length + (manual ? 1 : 0);
  const pill = document.getElementById('ctxPill');
  // Shorter text on mobile
  if (window.innerWidth <= 768) {
    pill.innerHTML = total > 0
      ? `<span class="pill-text">Ctx (${total})</span>`
      : '<span class="pill-text">+ Ctx</span>';
  } else {
    pill.innerHTML = total > 0
      ? `<span class="pill-text">Context (${total})</span>`
      : '<span class="pill-text">+ Context</span>';
  }
  pill.classList.toggle('active', total > 0);
}

// â”€â”€ Auto resize textarea â”€â”€
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    generate();
  }
}

// â”€â”€ Generate â”€â”€
async function generate() {
  if (isGenerating) return;

  const prompt = document.getElementById('promptInput').value.trim();
  if (!prompt) return;

  isGenerating = true;
  const sendBtn = document.getElementById('sendBtn');
  sendBtn.disabled = true;

  // Hide empty state
  document.getElementById('emptyState').classList.add('hidden');
  const msgs = document.getElementById('messages');
  msgs.classList.add('visible');

  // Build context
  let fullContext = '';
  const manual = document.getElementById('ctxManual')?.value?.trim() || '';
  if (contextSources.length > 0) {
    fullContext = contextSources.map(s => `--- ${s.type.toUpperCase()}: ${s.label} ---\n${s.content}`).join('\n\n');
  }
  if (manual) fullContext += (fullContext ? '\n\n' : '') + '--- MANUAL CONTEXT ---\n' + manual;

  // Build settings summary
  const wcLabel = WC_OPTIONS.flatMap(g => g.items).find(i => i.v === selectedWordCount);
  const toneLabel = TONES.find(t => t.v === selectedTone);
  const fwCount = selectedFrameworks.size;

  // Add user message
  const userMsg = document.createElement('div');
  userMsg.className = 'message user';
  userMsg.innerHTML = `
    <div class="msg-label"><div class="avatar">U</div> You</div>
    <div class="msg-body user-prompt">${escapeHtml(prompt)}</div>
    <div class="msg-tags">
      <span class="msg-tag">${wcLabel ? wcLabel.l : selectedWordCount + ' words'}</span>
      <span class="msg-tag">${toneLabel ? toneLabel.l : 'Conversational'}</span>
      <span class="msg-tag">${fwCount} frameworks</span>
      ${contextSources.length > 0 ? `<span class="msg-tag">${contextSources.length} source${contextSources.length > 1 ? 's' : ''}</span>` : ''}
    </div>
  `;
  msgs.appendChild(userMsg);

  // Add thinking indicator
  const thinkingEl = document.createElement('div');
  thinkingEl.className = 'message assistant';
  thinkingEl.innerHTML = `
    <div class="msg-label"><div class="avatar">SE</div> Script Engine</div>
    <div class="thinking">
      <div class="thinking-dots"><span></span><span></span><span></span></div>
      Generating script...
    </div>
  `;
  msgs.appendChild(thinkingEl);
  scrollToBottom();

  // Clear input
  document.getElementById('promptInput').value = '';
  document.getElementById('promptInput').style.height = 'auto';

  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        topic: prompt,
        audience: 'general audience (infer from prompt)',
        context: fullContext || null,
        wordCount: selectedWordCount,
        tone: selectedTone,
        frameworks: Array.from(selectedFrameworks)
      })
    });

    if (!response.ok) throw new Error(`Error ${response.status}`);
    const data = await response.json();
    const script = data.script || 'No script generated.';
    const meta = data.metadata || {};

    // Replace thinking with response
    thinkingEl.innerHTML = `
      <div class="msg-label"><div class="avatar">SE</div> Script Engine</div>
      <div class="msg-body">
        <div class="script-content">${escapeHtml(script)}</div>
      </div>
      <div class="msg-tags">
        <span class="msg-tag" style="color:var(--green)">${meta.actualWordCount || '?'} words</span>
        <span class="msg-tag">${meta.estimatedVideoDuration || '?'}</span>
      </div>
      <div class="script-actions">
        <button class="script-action-btn" onclick="copyText(this, \`${escapeForAttr(script)}\`)">ðŸ“‹ Copy</button>
        <button class="script-action-btn" onclick="downloadText(\`${escapeForAttr(script)}\`)">â†“ Download</button>
        <button class="script-action-btn" onclick="regenerateWith(\`${escapeForAttr(prompt)}\`)">â†» Regenerate</button>
      </div>
    `;
  } catch (err) {
    thinkingEl.innerHTML = `
      <div class="msg-label"><div class="avatar">SE</div> Script Engine</div>
      <div class="msg-body" style="color:#f87171">Error: ${escapeHtml(err.message)}. Make sure the n8n workflow is active.</div>
    `;
  }

  scrollToBottom();
  isGenerating = false;
  sendBtn.disabled = false;
}

function regenerateWith(prompt) {
  document.getElementById('promptInput').value = prompt;
  generate();
}

// â”€â”€ Utils â”€â”€
function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function escapeForAttr(str) {
  return str.replace(/\\/g,'\\\\').replace(/`/g,'\\`').replace(/\$/g,'\\$');
}

function scrollToBottom() {
  const area = document.getElementById('chatArea');
  setTimeout(() => area.scrollTop = area.scrollHeight, 50);
}

function copyText(btn, text) {
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'âœ“ Copied';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'ðŸ“‹ Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

function downloadText(text) {
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `script_${Date.now()}.txt`;
  a.click();
  URL.revokeObjectURL(url);
}

// â”€â”€ Init â”€â”€
renderWcDropdown();
renderToneDropdown();
renderFwDropdown();
</script>

</body>
</html>
